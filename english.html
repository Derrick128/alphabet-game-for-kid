<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ëã±ÊñáËÅΩÂäõ‰∫íÂãï</title>
    <script src="data.js"></script>
    <style>
        body { font-family: 'Arial Rounded MT Bold', sans-serif; background-color: #e3f2fd; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; touch-action: manipulation; }
        .container { width: 95%; max-width: 600px; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; background: white; padding: 10px 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        .back-btn { text-decoration: none; font-size: 1.5rem; }
        .mode-switch { display: flex; gap: 10px; }
        .mode-btn { padding: 8px 15px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; opacity: 0.6; transition: 0.3s; }
        .mode-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .mode-qa { background: #4fc3f7; color: #01579b; }
        .mode-sort { background: #ffb74d; color: #e65100; }
        #question-area { background: #fff; border-radius: 25px; padding: 20px; text-align: center; box-shadow: 0 8px 0 rgba(0,0,0,0.05); border: 4px solid #b3e5fc; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .main-speaker { width: 80px; height: 80px; background: #03a9f4; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; cursor: pointer; box-shadow: 0 6px 0 #0288d1; transition: transform 0.1s; }
        .main-speaker:active { transform: scale(0.95); box-shadow: 0 2px 0 #0288d1; }
        .question-text { font-size: 1.2rem; color: #0277bd; min-height: 1.5em; }
        #options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; }
        #options-grid.grid-mode { grid-template-columns: 1fr 1fr; }
        .card { background: white; border-radius: 20px; padding: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 5px 0 rgba(0,0,0,0.1); border: 3px solid #e1f5fe; transition: transform 0.1s; cursor: pointer; position: relative; }
        .card:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .card-speaker { width: 50px; height: 50px; background: #e0f7fa; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #0288d1; flex-shrink: 0; border: 2px solid #b3e5fc; z-index: 2; }
        .card-content { flex-grow: 1; text-align: center; font-size: 1.2rem; font-weight: bold; color: #444; padding: 0 10px; user-select: none; }
        .correct { background-color: #c8e6c9 !important; border-color: #4caf50 !important; }
        .wrong { background-color: #ffcdd2 !important; border-color: #ef5350 !important; animation: shake 0.4s; }
        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }
        #feedback-msg { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 1.2rem; display: none; z-index: 100; }
        .debug-panel { background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 10px; margin: 10px 0; font-size: 0.9rem; }
        .debug-panel details { margin: 5px 0; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-bar">
            <a href="index.html" class="back-btn">üè†</a>
            <div class="mode-switch">
                <button class="mode-btn mode-qa active" onclick="switchMode('QA')">üó£Ô∏è Â∞çË©±</button>
                <button class="mode-btn mode-sort" onclick="switchMode('SORT')">üóÇÔ∏è ÂàÜÈ°û</button>
            </div>
        </div>

        <!-- ÂÅµÈåØÈù¢Êùø -->
        <div class="debug-panel" id="debug-panel">
            <details>
                <summary><strong>üîç ËºâÂÖ•ÁãÄÊÖã</strong></summary>
                <div id="debug-info" style="margin-top: 10px; font-family: monospace; white-space: pre-wrap;"></div>
            </details>
        </div>

        <div id="question-area">
            <div class="main-speaker" onclick="playQuestion()">üîä</div>
            <div class="question-text" id="q-text">Ê∫ñÂÇô‰∏≠...</div>
        </div>

        <div id="options-grid"></div>
    </div>
    <div id="feedback-msg">Â§™Ê£í‰∫Ü!</div>

    <script>
        let currentMode = 'QA';
        let currentItem = null;

        // üî¥ ÂÅµÈåØËºîÂä©ÂáΩÊï∏
        function updateDebugInfo(msg) {
            const el = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            el.textContent += `[${timestamp}] ${msg}\n`;
            console.log(msg);
        }

        // üî¥ ÊîπÊàê async functionÔºåÂèØ‰ª•‰ΩøÁî® await
        async function init() {
            updateDebugInfo("üöÄ ÈñãÂßãÂàùÂßãÂåñ...");
            document.getElementById('q-text').innerText = "Ê≠£Âú®‰∏ãËºâÈ°åÂ∫´...";
            
            try {
                // Ê™¢Êü• GAME_DATA ÊòØÂê¶Â≠òÂú®
                if (typeof GAME_DATA === 'undefined') {
                    updateDebugInfo("‚ùå ÈåØË™§Ôºödata.js Ê≤íÊúâÊ≠£Á¢∫ËºâÂÖ•");
                    document.getElementById('q-text').innerText = "‚ùå data.js ËºâÂÖ•Â§±Êïó";
                    return;
                }

                updateDebugInfo("‚úÖ GAME_DATA Â∑≤ËºâÂÖ•");

                // Ê™¢Êü•ÊòØÂê¶Êúâ loadFromCloud ÂáΩÊï∏
                if (typeof GAME_DATA.loadFromCloud !== 'function') {
                    updateDebugInfo("‚ùå ÈåØË™§ÔºöloadFromCloud ÂáΩÊï∏‰∏çÂ≠òÂú®");
                    document.getElementById('q-text').innerText = "‚ùå data.js ÁâàÊú¨‰∏çÊ≠£Á¢∫";
                    return;
                }

                updateDebugInfo("üì° ÈñãÂßãÂæûÈõ≤Á´Ø‰∏ãËºâË≥áÊñô...");

                // Á≠âÂæÖ data.js Âéª Google ÊäìË≥áÊñô
                await GAME_DATA.loadFromCloud();

                updateDebugInfo(`üìä QA È°åÊï∏: ${GAME_DATA.ENGLISH.QA_LIST.length}`);
                updateDebugInfo(`üìä Sort È°åÊï∏: ${GAME_DATA.ENGLISH.SORT_LIST.length}`);

                // Ê™¢Êü•ÊúâÊ≤íÊúâÊäìÂà∞Ë≥áÊñô
                if (GAME_DATA.ENGLISH.QA_LIST.length === 0 && GAME_DATA.ENGLISH.SORT_LIST.length === 0) {
                    updateDebugInfo("‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≤íÊúâÊäìÂà∞‰ªª‰ΩïÈ°åÁõÆ");
                    document.getElementById('q-text').innerText = "‚ö†Ô∏è Ê≤íÊäìÂà∞È°åÁõÆ\nË´ãÊ™¢Êü•Ôºö\n1. Google Sheet ÊòØÂê¶Â∑≤„ÄåÁôºÂ∏ÉÂà∞Á∂≤Ë∑Ø„Äç\n2. Á∂≤ÂùÄÊòØÂê¶Ê≠£Á¢∫\n3. ÊòØÂê¶ÈÄèÈÅéÁ∂≤È†Å‰º∫ÊúçÂô®Âü∑Ë°å (‰∏çËÉΩÁõ¥Êé•ÈñãÂïüÊ™îÊ°à)";
                    return;
                }

                // ÈñãÂßãÈÅäÊà≤
                updateDebugInfo("üéÆ ÈñãÂßãÈÅäÊà≤ÔºÅ");
                switchMode('QA');

            } catch (error) {
                updateDebugInfo(`‚ùå ÂàùÂßãÂåñÈåØË™§: ${error.message}`);
                document.getElementById('q-text').innerText = `‚ùå ËºâÂÖ•Â§±Êïó: ${error.message}`;
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            
            if (mode === 'QA') {
                document.querySelector('.mode-qa').classList.add('active');
                document.getElementById('options-grid').classList.remove('grid-mode');
                if (GAME_DATA.ENGLISH.QA_LIST.length === 0) {
                    alert("QA È°åÂ∫´ÊòØÁ©∫ÁöÑÔºÅ");
                    updateDebugInfo("‚ö†Ô∏è QA È°åÂ∫´ÁÇ∫Á©∫");
                    return;
                }
            } else {
                document.querySelector('.mode-sort').classList.add('active');
                document.getElementById('options-grid').classList.add('grid-mode');
                if (GAME_DATA.ENGLISH.SORT_LIST.length === 0) {
                    alert("ÂàÜÈ°ûÈ°åÂ∫´ÊòØÁ©∫ÁöÑÔºÅ");
                    updateDebugInfo("‚ö†Ô∏è Sort È°åÂ∫´ÁÇ∫Á©∫");
                    return;
                }
            }
            loadLevel();
        }

        function loadLevel() {
            const grid = document.getElementById('options-grid');
            grid.innerHTML = ''; 
            
            if (currentMode === 'QA') {
                const list = GAME_DATA.ENGLISH.QA_LIST;
                currentItem = list[Math.floor(Math.random() * list.length)];
                document.getElementById('q-text').innerText = currentItem.q;
                updateDebugInfo(`üéØ ËºâÂÖ• QA È°åÁõÆ: ${currentItem.q}`);
                
                let options = [currentItem.a, ...currentItem.wrong];
                options.sort(() => Math.random() - 0.5);

                options.forEach(opt => {
                    createCard(opt, (card) => {
                        if (opt === currentItem.a) {
                            card.classList.add('correct');
                            showFeedback("Correct! Á≠îÂ∞ç‰∫Ü!");
                            playAudio("Correct! " + opt);
                            setTimeout(loadLevel, 2000);
                        } else {
                            card.classList.add('wrong');
                            playAudio("Try again");
                            setTimeout(() => card.classList.remove('wrong'), 500);
                        }
                    });
                });
                setTimeout(() => playAudio(currentItem.q), 500);

            } else {
                const list = GAME_DATA.ENGLISH.SORT_LIST;
                currentItem = list[Math.floor(Math.random() * list.length)];
                const themeName = currentItem.theme.includes(':') ? currentItem.theme.split(':')[1] : currentItem.theme;
                const cleanTheme = themeName.split('(')[0];

                document.getElementById('q-text').innerText = "ÊâæÂá∫: " + currentItem.theme;
                updateDebugInfo(`üéØ ËºâÂÖ• Sort È°åÁõÆ: ${currentItem.theme}`);
                
                let allWords = [...currentItem.targets, ...currentItem.decoys];
                allWords.sort(() => Math.random() - 0.5);
                currentItem.remaining = currentItem.targets.length;

                setTimeout(() => playAudio("Find " + cleanTheme), 500);

                allWords.forEach(word => {
                    createCard(word, (card) => {
                        if(card.classList.contains('correct')) return;

                        if (currentItem.targets.includes(word)) {
                            card.classList.add('correct');
                            playAudio(word);
                            currentItem.remaining--;
                            if(currentItem.remaining === 0) {
                                showFeedback("Good Job! ÂÖ®ÊâæÂà∞‰∫Ü!");
                                setTimeout(loadLevel, 2000);
                            }
                        } else {
                            card.classList.add('wrong');
                            playAudio("Oh no");
                            setTimeout(() => card.classList.remove('wrong'), 500);
                        }
                    });
                });
            }
        }

        function createCard(text, onClick) {
            const grid = document.getElementById('options-grid');
            const card = document.createElement('div');
            card.className = 'card';
            
            const speaker = document.createElement('div');
            speaker.className = 'card-speaker';
            speaker.innerText = 'üîä';
            speaker.onclick = (e) => {
                e.stopPropagation();
                playAudio(text);
                speaker.style.transform = "scale(1.2)";
                setTimeout(() => speaker.style.transform = "scale(1)", 200);
            };

            const content = document.createElement('div');
            content.className = 'card-content';
            content.innerText = text;

            card.appendChild(speaker);
            card.appendChild(content);
            card.onclick = () => onClick(card);
            grid.appendChild(card);
        }

        function playQuestion() {
            if(currentMode === 'QA') playAudio(currentItem.q);
            else {
                 const themeName = currentItem.theme.includes(':') ? currentItem.theme.split(':')[1] : currentItem.theme;
                 playAudio("Find " + themeName.split('(')[0]);
            }
        }

        function playAudio(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        function showFeedback(msg) {
            const el = document.getElementById('feedback-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂü∑Ë°å
        init();
    </script>
</body>
</html>
