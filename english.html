<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±æ–‡æŒ‘æˆ° - å¡«ç©ºç·´ç¿’</title>
    <style>
        body { font-family: 'Arial Rounded MT Bold', sans-serif; background-color: #e1f5fe; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; touch-action: none; }
        .container { width: 90%; max-width: 500px; background: white; padding: 20px; border-radius: 20px; text-align: center; border: 5px solid #0288d1; box-sizing: border-box; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .back-btn { padding: 5px 15px; background: #b0bec5; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; }
        
        /* é¡Œç›®å€å¡Š */
        #question-box { margin: 10px 0; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        
        /* å¡«ç©ºé¡Œé¡¯ç¤ºæ¨£å¼ */
        #puzzle-display { 
            font-size: 3.5em; 
            color: #333; 
            letter-spacing: 5px; 
            font-family: 'Courier New', monospace; /* ç­‰å¯¬å­—é«”è®“åº•ç·šæ¯”è¼ƒæ¸…æ¥š */
            font-weight: bold;
            background: #e0f7fa;
            padding: 10px 30px;
            border-radius: 15px;
            border: 2px dashed #0288d1;
        }

        .missing-char { color: #f44336; text-decoration: underline; }

        #hint-text { color: #0277bd; font-size: 1.2em; }
        
        /* ç•«å¸ƒ */
        #canvas-wrapper { position: relative; width: 100%; height: 200px; border: 4px dashed #81d4fa; border-radius: 15px; margin-bottom: 10px; background: #fff; cursor: crosshair; }
        canvas { width: 100%; height: 100%; touch-action: none; border-radius: 10px; }
        
        /* ç­”æ¡ˆå€ */
        #answer-reveal { display: none; margin: 10px 0; padding: 15px; background: #fff9c4; border-radius: 10px; border: 2px solid #fbc02d; }
        .correct-ans { font-size: 2.5em; color: #2e7d32; font-weight: bold; margin-top: 5px; display: block; }

        /* æŒ‰éˆ• */
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn { padding: 12px 10px; font-size: 1.2em; border: none; border-radius: 10px; color: white; cursor: pointer; flex: 1; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-audio { background: #29b6f6; border-radius: 50%; width: 60px; height: 60px; flex: none; display: flex; align-items: center; justify-content: center; font-size: 2em; box-shadow: 0 4px 0 #0288d1; cursor: pointer; }
        .btn-audio:active { transform: scale(0.95); box-shadow: 0 2px 0 #0288d1; }

        .btn-show { background: #039be5; }
        .btn-yes { background: #4caf50; display: none; }
        .btn-no { background: #f44336; display: none; }
        .btn-clear { background: #90a4ae; flex: 0.5; font-size: 1em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <a href="index.html" class="back-btn">ğŸ </a>
            <div id="level-title" style="color:#01579b; font-weight:bold;">Level 1</div>
            <div id="score-board" style="color:#555;">0/5</div>
        </div>

        <div id="question-box">
            <div id="puzzle-display">_at</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="btn-audio" onclick="playAudio()">ğŸ”Š</div>
                <span id="hint-text">è½è½çœ‹ï¼Œå¡«å…¥ç¼ºå°‘çš„å­—æ¯</span>
            </div>
        </div>

        <div id="canvas-wrapper">
            <canvas id="writeCanvas"></canvas>
            <div style="position: absolute; bottom: 5px; right: 5px; color: #ccc; font-size: 0.8em;">åœ¨æ­¤å¯«ä¸‹å­—æ¯</div>
        </div>

        <div id="answer-reveal">
            å®Œæ•´å–®å­—æ˜¯ï¼š
            <span class="correct-ans" id="correct-text"></span>
            <div>ä½ å¯«å°äº†å—ï¼Ÿ</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-clear" onclick="clearCanvas()">æ©¡çš®æ“¦</button>
            <button id="btn-show" class="btn btn-show" onclick="showAnswer()">çœ‹ç­”æ¡ˆ</button>
            <button id="btn-yes" class="btn btn-yes" onclick="judge(true)">â­• ç­”å°</button>
            <button id="btn-no" class="btn btn-no" onclick="judge(false)">âŒ ç­”éŒ¯</button>
        </div>
    </div>

    <script>
        // é©åˆ 5 æ­²çš„å–®å­—åº« (CVC words ç‚ºä¸»)
        const DATA = {
            1: ['cat', 'dog', 'pig', 'bus', 'map', 'sun', 'box', 'hat', 'net', 'six'], // L1: ç°¡å–®åè©
            2: ['red', 'big', 'hot', 'run', 'sad', 'wet', 'fox', 'pen', 'mom', 'dad'], // L2: å½¢å®¹è©/å‹•è©/äººç‰©
            3: ['cake', 'bike', 'kite', 'rose', 'cute', 'duck', 'fish', 'ship', 'king', 'book'] // L3: Magic E & æ··åˆéŸ³
        };
        const TITLES = { 
            1: "L1: å­—é¦–è½éŸ³ (Initial)", 
            2: "L2: æ¯éŸ³è½è¾¨ (Vowel)", 
            3: "L3: é€²éšæŒ‘æˆ° (Challenge)" 
        };

        let currentLevel = 1, score = 0, round = 0, currentWord = "";
        let missingIndex = 0; // ç´€éŒ„æŒ–ç©ºçš„æ˜¯ç¬¬å¹¾å€‹å­—
        
        const canvas = document.getElementById('writeCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            setupCanvas();
            startLevel();
        }

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            ctx.lineWidth = 5; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#333';
        }

        function startLevel() {
            score = 0; round = 0;
            document.getElementById('level-title').innerText = TITLES[currentLevel];
            nextQuestion();
        }

        function generatePuzzle(word) {
            // æ ¹æ“š Level æ±ºå®šæŒ–ç©ºé‚è¼¯
            let displayChars = word.split('');
            
            if (currentLevel === 1) {
                // Level 1: æŒ–æ‰ç¬¬ä¸€å€‹å­— (å­—é¦–) _at
                missingIndex = 0;
            } else if (currentLevel === 2) {
                // Level 2: æŒ–æ‰ä¸­é–“çš„æ¯éŸ³ (é€šå¸¸æ˜¯ç¬¬2å€‹å­—) c_t
                missingIndex = 1; 
            } else {
                // Level 3: éš¨æ©ŸæŒ–ä¸€å€‹ï¼Œæˆ–è€…æ˜¯å­—å°¾
                missingIndex = Math.floor(Math.random() * word.length);
            }
            
            displayChars[missingIndex] = '_';
            return displayChars.join(' '); // åŠ ç©ºæ ¼è®“å­—æ¯åˆ†é–‹ä¸€é»: c _ t
        }

        function nextQuestion() {
            if (round >= 5) {
                if (score >= 4) {
                    if (currentLevel < 3) {
                        alert(`ğŸ‰ ç­”å° ${score} é¡Œï¼å¤ªæ£’äº†ï¼æ™‰ç´šä¸‹ä¸€é—œï¼`); currentLevel++; startLevel();
                    } else {
                        alert("ğŸ† æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰å¡«ç©ºæŒ‘æˆ°ï¼"); location.href = 'index.html';
                    }
                } else {
                    alert("åŠ æ²¹ï¼å†è©¦ä¸€æ¬¡ï¼"); startLevel();
                }
                return;
            }
            round++;
            document.getElementById('score-board').innerText = `é¡Œæ•¸: ${round}/5 (å¾—åˆ†: ${score})`;
            
            // éš¨æ©Ÿé¸å­—
            const wordList = DATA[currentLevel];
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            
            // ç”¢ç”ŸæŒ–ç©ºé¡Œç›®
            const puzzleText = generatePuzzle(currentWord);
            document.getElementById('puzzle-display').innerText = puzzleText;

            // é‡ç½®ä»‹é¢
            clearCanvas();
            document.getElementById('answer-reveal').style.display = 'none';
            document.getElementById('btn-show').style.display = 'block';
            document.getElementById('btn-yes').style.display = 'none';
            document.getElementById('btn-no').style.display = 'none';
            document.querySelector('.btn-clear').style.display = 'block';
            
            // è‡ªå‹•æ’­æ”¾
            setTimeout(playAudio, 500);
        }

        function playAudio() {
            const u = new SpeechSynthesisUtterance(currentWord);
            u.lang = 'en-US';
            u.rate = 0.8; 
            window.speechSynthesis.speak(u);
        }

        function showAnswer() {
            // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆï¼Œä¸¦æŠŠç¼ºå°‘çš„å­—æ¨™ç´…
            let html = "";
            const chars = currentWord.split('');
            chars.forEach((char, index) => {
                if (index === missingIndex) {
                    html += `<span style="color:#f44336; text-decoration:underline;">${char}</span>`;
                } else {
                    html += char;
                }
            });

            document.getElementById('correct-text').innerHTML = html;
            document.getElementById('answer-reveal').style.display = 'block';
            playAudio();
            
            document.getElementById('btn-show').style.display = 'none';
            document.querySelector('.btn-clear').style.display = 'none';
            document.getElementById('btn-yes').style.display = 'block';
            document.getElementById('btn-no').style.display = 'block';
        }

        function judge(isCorrect) {
            if(isCorrect) score++;
            nextQuestion();
        }

        function setupCanvas() {
            const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const {x,y} = pos(e); ctx.moveTo(x,y); };
            const move = (e) => { if(!isDrawing) return; e.preventDefault(); const {x,y} = pos(e); ctx.lineTo(x,y); ctx.stroke(); };
            const end = () => isDrawing = false;
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end); canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        }
        function pos(e) {
            const r = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - r.left, y: cy - r.top };
        }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        init();
    </script>
</body>
</html>
