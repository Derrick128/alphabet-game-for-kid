<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½å°å­¸éœ¸ï¼šè‹±æ–‡ã€æ•¸å­¸ã€ç·´å­—</title>
    <style>
        /* --- å…¨å±€æ¨£å¼ --- */
        body {
            font-family: 'Arial Rounded MT Bold', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            background-color: #f0f4c3; /* æŸ”å’ŒèƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ²å‹•å½±éŸ¿å¯«å­— */
            touch-action: none; /* ç¦æ­¢é è¨­è§¸æ§è¡Œç‚º */
        }

        .container {
            width: 95%;
            max-width: 800px;
            background-color: white;
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 20px;
            text-align: center;
            position: relative;
            border: 5px solid #cddc39;
        }

        h1 { color: #827717; margin-top: 0; }
        
        .hidden { display: none !important; }

        /* --- ä¸»é¸å–®æ¨£å¼ --- */
        #menu-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .menu-btn {
            padding: 30px;
            font-size: 2em;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.1s;
            color: white;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2);
            font-weight: bold;
        }

        .btn-eng { background-color: #4fc3f7; border: 4px solid #0288d1; }
        .btn-math { background-color: #ff8a65; border: 4px solid #d84315; }
        .btn-write { background-color: #aed581; border: 4px solid #558b2f; }

        .menu-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 rgba(0,0,0,0.2); }

        /* --- éŠæˆ²å€æ¨£å¼ --- */
        #game-screen h2 { color: #00838f; }
        #level-indicator { font-size: 1.2em; color: #555; margin-bottom: 10px; }
        #question-text { font-size: 1.8em; color: #ef6c00; margin: 20px 0; font-weight: bold; }
        
        #options-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .option-btn {
            width: 40%;
            padding: 20px;
            font-size: 2em;
            border: 3px solid #ccc;
            border-radius: 15px;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 5px 0 #bbb;
        }

        .option-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #bbb; }
        .correct { background-color: #b2dfdb !important; border-color: #009688 !important; }
        .incorrect { background-color: #ffcdd2 !important; border-color: #e57373 !important; }

        /* --- ç·´å­—å€æ¨£å¼ --- */
        #writing-screen canvas {
            border: 4px dashed #bdbdbd;
            border-radius: 15px;
            cursor: crosshair;
            touch-action: none;
            background-color: #fff;
            margin: 10px auto;
            display: block;
        }

        .writing-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .ctrl-btn {
            padding: 10px 20px;
            font-size: 1.2em;
            border-radius: 10px;
            border: none;
            background-color: #7e57c2;
            color: white;
            cursor: pointer;
        }

        #back-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            background: #bdbdbd;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

    </style>
</head>
<body>

    <div class="container">
        <button id="back-btn" class="hidden" onclick="goHome()">ğŸ  å›é¦–é </button>

        <div id="menu-screen">
            <h1>ğŸ’ å¿«æ¨‚å­¸ç¿’æ¨‚åœ’</h1>
            <button class="menu-btn btn-eng" onclick="startGame('ENGLISH')">ğŸ”  è‹±æ–‡æŒ‘æˆ° (English)</button>
            <button class="menu-btn btn-math" onclick="startGame('MATH')">ğŸ§® æ•¸å­¸æŒ‘æˆ° (Math)</button>
            <button class="menu-btn btn-write" onclick="startWriting()">âœï¸ ç·´å­—å°æ•™å®¤ (Writing)</button>
        </div>

        <div id="game-screen" class="hidden">
            <h2 id="game-title">æŒ‘æˆ°é–‹å§‹</h2>
            <div id="level-indicator">Level 1 - ç¬¬ 1/5 é¡Œ</div>
            <div id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <div id="options-area"></div>
            <div id="feedback" style="height: 30px; margin-top: 10px; font-size: 1.5em; font-weight: bold;"></div>
        </div>

        <div id="writing-screen" class="hidden">
            <h2 id="writing-title">ç·´å­—: A</h2>
            <canvas id="writeCanvas" width="300" height="300"></canvas>
            
            <div class="writing-controls">
                <button class="ctrl-btn" onclick="prevLetter()">â—€ ä¸Šä¸€å€‹</button>
                <button class="ctrl-btn" style="background:#ef5350" onclick="clearCanvas()">æ¸…é™¤é‡å¯«</button>
                <button class="ctrl-btn" style="background:#ffa726" onclick="toggleCase()">åˆ‡æ›å¤§å°å¯«</button>
                <button class="ctrl-btn" onclick="nextLetter()">ä¸‹ä¸€å€‹ â–¶</button>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentMode = 'MENU';
        let gameSubject = ''; // 'ENGLISH' or 'MATH'
        let currentLevel = 1;
        let currentRound = 0;
        let score = 0;
        let targetAnswer = '';
        
        // ç·´å­—ç›¸é—œè®Šæ•¸
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        let currentLetterIndex = 0;
        let isUpperCase = true;
        let canvas, ctx;
        let isDrawing = false;

        // --- æ ¸å¿ƒè³‡æ–™åº« ---
        const DB = {
            ENGLISH: {
                L1: { title: "Level 1: å­—æ¯è½åŠ›", type: "alphabet" },
                L2: { title: "Level 2: å–®å­—æ‹¼è®€ (Phonics)", type: "cvc" },
                L3: { title: "Level 3: å¸¸è¦‹å­— (Sight Words)", type: "sight" }
            },
            MATH: {
                L1: { title: "Level 1: æ•¸å­—æ¯”å¤§å°", type: "compare" },
                L2: { title: "Level 2: ç°¡å–®åŠ æ³•", type: "add" },
                L3: { title: "Level 3: ç°¡å–®æ¸›æ³•", type: "sub" }
            }
        };

        const WORDS = {
            CVC: ['cat', 'dog', 'pig', 'box', 'hat', 'sun', 'bus', 'red', 'six', 'fox'],
            SIGHT: ['the', 'and', 'you', 'is', 'play', 'see', 'look', 'big', 'my', 'to']
        };

        // --- ç•«é¢å°èˆª ---
        function showScreen(screenId) {
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            const backBtn = document.getElementById('back-btn');
            if(screenId === 'menu-screen') backBtn.classList.add('hidden');
            else backBtn.classList.remove('hidden');
        }

        function goHome() {
            showScreen('menu-screen');
            stopVoice();
        }

        // --- èªéŸ³åŠŸèƒ½ ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.8;
                window.speechSynthesis.speak(u);
            }
        }
        function stopVoice() { window.speechSynthesis.cancel(); }

        // ==========================================
        // Part A: æ¸¬é©—éŠæˆ²é‚è¼¯ (è‹±æ–‡/æ•¸å­¸)
        // ==========================================

        function startGame(subject) {
            gameSubject = subject;
            currentLevel = 1;
            startLevel();
        }

        function startLevel() {
            score = 0;
            currentRound = 0;
            showScreen('game-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentRound >= 5) {
                // é—œå¡çµæŸæª¢æŸ¥
                if (score >= 4) {
                    if (currentLevel < 3) {
                        currentLevel++;
                        alert(`ğŸ‰ å¤ªæ£’äº†ï¼æ™‰ç´š Level ${currentLevel}ï¼`);
                        startLevel();
                    } else {
                        alert("ğŸ† æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é—œå¡ï¼ä½ æ˜¯è¶…ç´šå°å­¸éœ¸ï¼");
                        goHome();
                    }
                } else {
                    alert("ğŸ’ª åŠ æ²¹ï¼Œå†è©¦ä¸€æ¬¡é€™å€‹é—œå¡ï¼");
                    startLevel(); // é‡ç©æœ¬é—œ
                }
                return;
            }

            currentRound++;
            const levelKey = `L${currentLevel}`;
            const config = DB[gameSubject][levelKey];
            
            document.getElementById('game-title').innerText = `${gameSubject === 'ENGLISH' ? 'è‹±æ–‡' : 'æ•¸å­¸'} - ${config.title}`;
            document.getElementById('level-indicator').innerText = `ç¬¬ ${currentRound} / 5 é¡Œ (ç´¯ç© ${score} åˆ†)`;
            document.getElementById('feedback').innerText = "";

            // æ ¹æ“šé¡å‹ç”¢ç”Ÿé¡Œç›®
            if (gameSubject === 'ENGLISH') generateEnglishQuestion(config.type);
            else generateMathQuestion(config.type);
        }

        // --- è‹±æ–‡é¡Œç›®ç”Ÿæˆ ---
        function generateEnglishQuestion(type) {
            let options = [];
            
            if (type === 'alphabet') {
                targetAnswer = alphabet[Math.floor(Math.random() * 26)];
                document.getElementById('question-text').innerText = "ğŸ”Š è«‹è½è²éŸ³ï¼Œé¸å‡ºæ­£ç¢ºå­—æ¯";
                // é¸é …é‚è¼¯
                let set = new Set([targetAnswer]);
                while(set.size < 4) set.add(alphabet[Math.floor(Math.random() * 26)]);
                options = Array.from(set).sort();
                speak(targetAnswer);
            
            } else if (type === 'cvc' || type === 'sight') {
                const source = type === 'cvc' ? WORDS.CVC : WORDS.SIGHT;
                targetAnswer = source[Math.floor(Math.random() * source.length)];
                document.getElementById('question-text').innerText = `ğŸ”Š è«‹æ‰¾å‡ºå–®å­—: "${targetAnswer}"`;
                
                let set = new Set([targetAnswer]);
                while(set.size < 4) set.add(source[Math.floor(Math.random() * source.length)]);
                options = Array.from(set).sort(() => Math.random() - 0.5);
                setTimeout(() => speak(targetAnswer), 500);
            }

            renderOptions(options);
        }

        // --- æ•¸å­¸é¡Œç›®ç”Ÿæˆ ---
        function generateMathQuestion(type) {
            let options = [];
            
            if (type === 'compare') {
                let n1 = Math.floor(Math.random() * 50) + 1;
                let n2 = Math.floor(Math.random() * 50) + 1;
                while(n1 === n2) n2 = Math.floor(Math.random() * 50) + 1;
                
                let isMax = Math.random() > 0.5;
                targetAnswer = isMax ? Math.max(n1, n2) : Math.min(n1, n2);
                document.getElementById('question-text').innerText = `å“ªä¸€å€‹æ•¸å­—æ¯”è¼ƒã€${isMax ? 'å¤§' : 'å°'}ã€‘ï¼Ÿ`;
                options = [n1, n2];
            
            } else if (type === 'add') {
                let n1 = Math.floor(Math.random() * 10) + 1;
                let n2 = Math.floor(Math.random() * 10) + 1;
                targetAnswer = n1 + n2;
                document.getElementById('question-text').innerText = `${n1} + ${n2} = ?`;
                
                let set = new Set([targetAnswer]);
                while(set.size < 3) set.add(targetAnswer + Math.floor(Math.random()*5) * (Math.random()>0.5?1:-1));
                options = Array.from(set).filter(n=>n>0).sort((a,b)=>a-b);
            
            } else if (type === 'sub') {
                let n1 = Math.floor(Math.random() * 10) + 5;
                let n2 = Math.floor(Math.random() * n1);
                targetAnswer = n1 - n2;
                document.getElementById('question-text').innerText = `${n1} - ${n2} = ?`;
                
                let set = new Set([targetAnswer]);
                while(set.size < 3) set.add(Math.abs(targetAnswer + Math.floor(Math.random()*3) * (Math.random()>0.5?1:-1)));
                options = Array.from(set).sort((a,b)=>a-b);
            }

            renderOptions(options);
        }

        function renderOptions(arr) {
            const area = document.getElementById('options-area');
            area.innerHTML = '';
            arr.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, btn);
                area.appendChild(btn);
            });
        }

        function checkAnswer(val, btn) {
            // é–å®šæŒ‰éˆ•
            document.querySelectorAll('.option-btn').forEach(b => b.onclick = null);
            
            if (val == targetAnswer) {
                btn.classList.add('correct');
                document.getElementById('feedback').innerText = "Correct! ç­”å°äº†ï¼ğŸŒŸ";
                document.getElementById('feedback').style.color = "green";
                speak("Good job");
                score++;
            } else {
                btn.classList.add('incorrect');
                document.getElementById('feedback').innerText = `ç­”æ¡ˆæ˜¯ ${targetAnswer}`;
                document.getElementById('feedback').style.color = "red";
                speak("Try again");
                // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
                document.querySelectorAll('.option-btn').forEach(b => {
                    if(b.innerText == targetAnswer) b.classList.add('correct');
                });
            }

            setTimeout(loadQuestion, 2000);
        }

        // ==========================================
        // Part B: ç·´å­—æ¿é‚è¼¯ (Canvas & Touch)
        // ==========================================

        function startWriting() {
            showScreen('writing-screen');
            currentLetterIndex = 0;
            isUpperCase = true;
            initCanvas();
            drawTemplate();
        }

        function initCanvas() {
            canvas = document.getElementById('writeCanvas');
            ctx = canvas.getContext('2d');
            
            // è¨­ç½®ç¹ªåœ–å±¬æ€§
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 15; // ç­†è§¸ç²—ç´°
            ctx.strokeStyle = '#333'; // ç­†è·¡é¡è‰²

            // äº‹ä»¶ç›£è½ (æ»‘é¼  + è§¸æ§)
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseout', endDraw);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢æ»¾å‹•
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, {passive: false});

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousemove", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, {passive: false});

            canvas.addEventListener('touchend', (e) => {
                const mouseEvent = new MouseEvent("mouseup", {});
                canvas.dispatchEvent(mouseEvent);
            });
        }

        function getPos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const pos = getPos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(canvas, e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function endDraw() {
            isDrawing = false;
        }

        // ç¹ªè£½èƒŒæ™¯å­—æ¯ (æç´…ç¯„æœ¬)
        function drawTemplate() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let letter = alphabet[currentLetterIndex];
            if (!isUpperCase) letter = letter.toLowerCase();

            document.getElementById('writing-title').innerText = `ç·´ç¿’å¯«: ${letter}`;

            // ç¹ªè£½æ·ºç°è‰²ç¯„æœ¬
            ctx.save();
            ctx.font = "200px Arial"; // å­—é«”å¤§å°
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#e0e0e0"; // æ·ºç°è‰²
            ctx.fillText(letter, canvas.width/2, canvas.height/2 + 20);
            
            // ç¹ªè£½æ ¼ç·š (è¼”åŠ©ç·š)
            ctx.strokeStyle = "#ffe0b2";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height/2);
            ctx.lineTo(canvas.width, canvas.height/2); // ä¸­ç·š
            ctx.moveTo(canvas.width/2, 0);
            ctx.lineTo(canvas.width/2, canvas.height); // å‚ç›´ç·š
            ctx.stroke();
            
            ctx.restore(); // æ¢å¾©ç­†åˆ·è¨­å®š
        }

        function clearCanvas() {
            drawTemplate(); // é‡æ–°ç¹ªè£½ç¯„æœ¬å°±æ˜¯æ¸…é™¤ç­†è·¡
        }

        function nextLetter() {
            if (currentLetterIndex < 25) {
                currentLetterIndex++;
                drawTemplate();
            }
        }

        function prevLetter() {
            if (currentLetterIndex > 0) {
                currentLetterIndex--;
                drawTemplate();
            }
        }

        function toggleCase() {
            isUpperCase = !isUpperCase;
            drawTemplate();
        }

    </script>
</body>
</html>
