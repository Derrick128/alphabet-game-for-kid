<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸æŒ‘æˆ° - AI è¾¨è­˜ç‰ˆ</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="data.js"></script>
    <script src="sound.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #fff3e0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; touch-action: none; }
        .container { width: 90%; max-width: 500px; background: white; padding: 20px; border-radius: 20px; text-align: center; border: 5px solid #d84315; box-sizing: border-box; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .back-btn { padding: 5px 15px; background: #b0bec5; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; }
        
        #question-box { font-size: 2.5em; margin: 10px 0; color: #e65100; font-weight: bold; min-height: 60px; }
        
        /* ç•«å¸ƒèƒŒæ™¯å¿…é ˆæ˜¯ç™½è‰²ï¼Œä¸ç„¶ OCR æœƒèª¤åˆ¤ */
        #canvas-wrapper { position: relative; width: 100%; height: 250px; border: 4px dashed #ffab91; border-radius: 15px; margin-bottom: 10px; background: #fff; cursor: crosshair; }
        canvas { width: 100%; height: 100%; touch-action: none; border-radius: 10px; }
        
        /* ç‹€æ…‹é¡¯ç¤ºå€ */
        #status-msg { height: 30px; margin: 10px 0; font-size: 1.2rem; font-weight: bold; color: #555; }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn { padding: 12px 20px; font-size: 1.2em; border: none; border-radius: 10px; color: white; cursor: pointer; flex: 1; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.2s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-clear { background: #90a4ae; flex: 0.5; }
        .btn-check { background: #ff9800; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #fff; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <a href="index.html" class="back-btn" onclick="playClick()">ğŸ </a>
            <div id="level-title" style="color:#bf360c; font-weight:bold;">Level 1</div>
            <div id="score-board" style="color:#555;">0/5</div>
        </div>

        <div id="question-box">loading...</div>

        <div id="canvas-wrapper">
            <canvas id="writeCanvas"></canvas>
            <div style="position: absolute; bottom: 5px; right: 5px; color: #ccc; font-size: 0.8em;">è«‹å¯«ä¸‹æ•¸å­—</div>
        </div>

        <div id="status-msg"></div>

        <div class="btn-group">
            <button class="btn btn-clear" onclick="clearCanvas()">æ©¡çš®æ“¦</button>
            <button id="btn-check" class="btn btn-check" onclick="recognizeHandwriting()">
                <div class="spinner" id="loading-spin"></div>
                <span id="btn-text">äº¤å· (AI è¾¨è­˜)</span>
            </button>
        </div>
        <div id="hidden-ans" style="display:none; color:#ccc; margin-top:5px;"></div>
    </div>

    <script>
        // 1. åˆå§‹åŒ–è³‡æ–™
        const LEVELS_CONFIG = (typeof GAME_DATA !== 'undefined') ? GAME_DATA.MATH.LEVELS : {};
        
        let currentLevel = 1, score = 0, round = 0, currentAnswer = 0;
        const canvas = document.getElementById('writeCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let worker = null; // Tesseract å·¥ä½œæ ¸å¿ƒ

        async function init() {
            if(Object.keys(LEVELS_CONFIG).length === 0) {
                // å¦‚æœæ²’æœ‰è®€åˆ° data.js çš„å‚™ç”¨æ–¹æ¡ˆ
                alert("æ‰¾ä¸åˆ° data.jsï¼Œå°‡ä½¿ç”¨é è¨­é¡Œç›®");
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            setupCanvas();
            
            // é å…ˆåˆå§‹åŒ– OCR å¼•æ“ (åŠ é€Ÿç¬¬ä¸€æ¬¡è¾¨è­˜)
            document.getElementById('status-msg').innerText = "AI å¼•æ“æš–èº«ä¸­...";
            worker = await Tesseract.createWorker('eng');
            
            // è¨­å®šåªè¾¨è­˜æ•¸å­— (ç™½åå–®)
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789'
            });
            
            document.getElementById('status-msg').innerText = "";
            startLevel();
        }

        // --- æ ¸å¿ƒï¼šAI è¾¨è­˜é‚è¼¯ ---
        async function recognizeHandwriting() {
            const btn = document.getElementById('btn-check');
            const spin = document.getElementById('loading-spin');
            const txt = document.getElementById('btn-text');
            const status = document.getElementById('status-msg');

            // 1. UI è®Šæ›´ï¼šé¡¯ç¤ºè¼‰å…¥ä¸­
            btn.disabled = true;
            btn.style.background = "#ccc";
            spin.style.display = "block";
            txt.innerText = "è¾¨è­˜ä¸­...";
            status.innerText = "ğŸ¤” AI æ­£åœ¨çœ‹ä½ å¯«ä»€éº¼...";
            playClick(); // éŸ³æ•ˆ

            try {
                // 2. è™•ç†åœ–ç‰‡ï¼šå¿…é ˆå°‡èƒŒæ™¯è½‰ç‚ºç´”ç™½ (Canvas é è¨­é€æ˜ï¼Œè½‰åœ–æœƒè®Šé»‘ï¼ŒOCR æœƒå¤±æ•—)
                const dataURL = getCanvasWithWhiteBackground();

                // 3. åŸ·è¡Œè¾¨è­˜
                const { data: { text } } = await worker.recognize(dataURL);
                
                // 4. æ¸…ç†çµæœ (å»é™¤ç©ºç™½èˆ‡æ›è¡Œ)
                let recognizedNum = text.trim();
                console.log("AI çœ‹åˆ°:", recognizedNum); // é™¤éŒ¯ç”¨

                // 5. åˆ¤å®šçµæœ
                if (recognizedNum === "") {
                    status.innerText = "â“ æ²’çœ‹åˆ°æ•¸å­—ï¼Œå†å¯«æ¸…æ¥šä¸€é»ï¼Ÿ";
                    playAudio && playClick(); // æç¤ºéŸ³
                } else if (parseInt(recognizedNum) === currentAnswer) {
                    status.innerText = `âœ… ç­”å°äº†ï¼æ˜¯ ${recognizedNum}`;
                    status.style.color = "green";
                    if(typeof playSuccess === 'function') playSuccess();
                    score++;
                    setTimeout(nextQuestion, 1500);
                    return; // çµæŸ
                } else {
                    status.innerText = `âŒ é€™æ˜¯ ${recognizedNum} å—ï¼Ÿç­”æ¡ˆä¸å°å–”`;
                    status.style.color = "red";
                    if(typeof playClick === 'function') playClick();
                }

            } catch (err) {
                console.error(err);
                status.innerText = "âš ï¸ AI ç´¯äº†ï¼Œè«‹é‡è©¦";
            } finally {
                // 6. æ¢å¾© UI
                btn.disabled = false;
                btn.style.background = "#ff9800";
                spin.style.display = "none";
                txt.innerText = "äº¤å· (AI è¾¨è­˜)";
            }
        }

        // è¼”åŠ©ï¼šå°‡é€æ˜ Canvas è½‰ç‚ºç™½åº•åœ–ç‰‡
        function getCanvasWithWhiteBackground() {
            const w = canvas.width;
            const h = canvas.height;
            
            // å»ºç«‹ä¸€å€‹è‡¨æ™‚ Canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tCtx = tempCanvas.getContext('2d');

            // å¡«æ»¿ç™½è‰²èƒŒæ™¯
            tCtx.fillStyle = '#ffffff';
            tCtx.fillRect(0, 0, w, h);
            
            // æŠŠåŸæœ¬çš„ç­†è·¡ç•«ä¸Šå»
            tCtx.drawImage(canvas, 0, 0);
            
            return tempCanvas.toDataURL('image/png');
        }

        // --- éŠæˆ²æµç¨‹ (èˆ‡ä¹‹å‰ç›¸ä¼¼) ---

        // (å‚™ç”¨) å¦‚æœ data.js å£æ‰çš„é è¨­ç”¢ç”Ÿå™¨
        function generateQuestion(level) {
            let config = LEVELS_CONFIG[level];
            if(!config) config = { min: 10, max: 20, type: 'ADD' }; // Fallback
            
            const { min, max, type } = config;
            
            if (type === 'ADD_CARRY') {
                let a = r(min, max); 
                let b = r(5, 9);
                while((a%10) + b < 10) b++;
                return { q: `${a} + ${b} = ?`, a: a+b };
            } else if (type === 'SUB_BORROW') {
                let a = r(min, max);
                let b = r(5, 9);
                while((a%10) >= b) a = r(min, max);
                return { q: `${a} - ${b} = ?`, a: a-b };
            } else {
                let a = r(10, 20); let b = r(5, 10); let c = r(2, 8);
                return (Math.random()>0.5) ? { q: `${a} + ${b} - ${c} = ?`, a: a+b-c } : { q: `${a} - ${b} + ${c} = ?`, a: a-b+c };
            }
        }

        function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function startLevel() {
            score = 0; round = 0;
            document.getElementById('level-title').innerText = LEVELS_CONFIG[currentLevel]?.title || "Level " + currentLevel;
            nextQuestion();
        }

        function nextQuestion() {
            if (round >= 5) {
                if (score >= 4) {
                    if (currentLevel < 3) {
                        alert(`ğŸ‰ ç­”å° ${score} é¡Œï¼Œæ™‰ç´šä¸‹ä¸€é—œï¼`); currentLevel++; startLevel();
                    } else {
                        alert("ğŸ† æ•¸å­¸å¤§å¸«ï¼å…¨éƒ¨é€šé—œï¼"); location.href = 'index.html';
                    }
                } else {
                    alert("å†ç·´ç¿’ä¸€æ¬¡å§ï¼åŠ æ²¹ï¼"); startLevel();
                }
                return;
            }
            round++;
            document.getElementById('score-board').innerText = `é¡Œæ•¸: ${round}/5 (å¾—åˆ†: ${score})`;
            
            clearCanvas();
            document.getElementById('status-msg').innerText = "";
            document.getElementById('status-msg').style.color = "#555";

            const qData = generateQuestion(currentLevel);
            document.getElementById('question-box').innerText = qData.q;
            currentAnswer = qData.a;
            
            // å·çœ‹ç­”æ¡ˆ (Debugç”¨)
            document.getElementById('hidden-ans').innerText = currentAnswer;
        }

        // --- ç•«å¸ƒè¨­å®š ---
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            setupCtx();
        }

        function setupCtx() {
            ctx.lineWidth = 8; // ç­†è§¸ç²—ä¸€é»ï¼ŒAI æ¯”è¼ƒå¥½èª
            ctx.lineCap = 'round'; 
            ctx.lineJoin = 'round'; 
            ctx.strokeStyle = 'black'; // é»‘è‰²å°æ¯”æœ€å¼·
        }

        function setupCanvas() {
            setupCtx();
            const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const {x,y} = pos(e); ctx.moveTo(x,y); };
            const move = (e) => { if(!isDrawing) return; e.preventDefault(); const {x,y} = pos(e); ctx.lineTo(x,y); ctx.stroke(); };
            const end = () => isDrawing = false;
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end); canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        }
        function pos(e) {
            const r = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - r.left, y: cy - r.top };
        }
        function clearCanvas() { 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            document.getElementById('status-msg').innerText = "";
            playClick();
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
