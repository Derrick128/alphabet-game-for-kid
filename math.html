<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸æŒ‘æˆ° - æ¥µé€Ÿç‰ˆ</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="data.js"></script>
    <script src="sound.js"></script>
    <style>
        body { font-family: 'Arial Rounded MT Bold', sans-serif; background-color: #fff3e0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; touch-action: none; }
        .container { width: 90%; max-width: 500px; background: white; padding: 20px; border-radius: 20px; text-align: center; border: 5px solid #d84315; box-sizing: border-box; position: relative; }
        
        /* é ‚éƒ¨å°èˆª */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .back-btn { padding: 5px 12px; background: #b0bec5; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.9rem; }
        
        /* AI é–‹é—œ */
        .ai-toggle {
            font-size: 0.8rem; background: #eee; padding: 5px 10px; border-radius: 15px; cursor: pointer; border: 1px solid #ccc; display: flex; align-items: center; gap: 5px;
        }
        .ai-toggle.active { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #999; }
        .active .dot { background: #4caf50; box-shadow: 0 0 5px #4caf50; }

        #question-box { font-size: 2.5em; margin: 10px 0; color: #e65100; font-weight: bold; min-height: 60px; }
        
        #canvas-wrapper { position: relative; width: 100%; height: 250px; border: 4px dashed #ffab91; border-radius: 15px; margin-bottom: 10px; background: #fff; cursor: crosshair; }
        canvas { width: 100%; height: 100%; touch-action: none; border-radius: 10px; }
        
        #status-msg { height: 20px; margin: 5px 0; font-size: 0.85rem; color: #888; white-space: nowrap; overflow: hidden; }

        /* ç­”æ¡ˆé¡¯ç¤ºå€ */
        #answer-reveal { display: none; margin: 10px 0; padding: 15px; background: #fff8e1; border-radius: 10px; border: 2px solid #ffecb3; }
        .correct-ans { font-size: 2.2em; color: #2e7d32; font-weight: bold; }

        /* æŒ‰éˆ•å€ */
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 0; font-size: 1.2em; border: none; border-radius: 10px; color: white; cursor: pointer; flex: 1; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-clear { background: #90a4ae; flex: 0.5; }
        
        /* AI æŒ‰éˆ• */
        .btn-check { background: #ff9800; font-weight: bold; display: none; } /* é è¨­éš±è— */
        
        /* æ‰‹å‹•æŒ‰éˆ• */
        .btn-show { background: #039be5; display: block; } /* é è¨­é¡¯ç¤º */
        
        .btn-yes { background: #66bb6a; display: none; }
        .btn-no { background: #ef5350; display: none; }

        /* è¼‰å…¥è½‰åœˆåœˆ */
        .spinner {
            border: 3px solid #ffffff40; border-top: 3px solid #fff; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <a href="index.html" class="back-btn" onclick="playClick()">ğŸ </a>
            <div id="ai-switch" class="ai-toggle" onclick="toggleAI()">
                <div class="dot"></div> <span id="ai-label">AI å•Ÿå‹•ä¸­...</span>
            </div>
        </div>

        <div id="level-title" style="color:#bf360c; font-weight:bold; margin-bottom:5px;">Level 1</div>
        <div id="question-box">...</div>

        <div id="canvas-wrapper">
            <canvas id="writeCanvas"></canvas>
            <div style="position: absolute; bottom: 5px; right: 5px; color: #ddd; font-size: 0.8em;">åœ¨æ­¤æ›¸å¯«</div>
        </div>

        <div id="status-msg"></div>

        <div id="answer-reveal">
            æ­£ç¢ºç­”æ¡ˆï¼š<span class="correct-ans" id="correct-text"></span>
        </div>

        <div class="btn-group">
            <button class="btn btn-clear" id="btn-clear" onclick="clearCanvas()">é‡å¯«</button>
            
            <button id="btn-check" class="btn btn-check" onclick="recognizeHandwriting()">
                <span class="spinner" id="loading-spin" style="display:none"></span>
                <span id="btn-text">AI äº¤å·</span>
            </button>

            <button id="btn-show" class="btn btn-show" onclick="showAnswer()">çœ‹ç­”æ¡ˆ</button>

            <button id="btn-yes" class="btn btn-yes" onclick="judge(true)">â­• ç­”å°</button>
            <button id="btn-no" class="btn btn-no" onclick="judge(false)">âŒ ç­”éŒ¯</button>
        </div>
    </div>

    <script>
        // è¨­å®š
        const LEVELS_CONFIG = (typeof GAME_DATA !== 'undefined') ? GAME_DATA.MATH.LEVELS : {};
        
        let currentLevel = 1, score = 0, round = 0, currentAnswer = 0;
        const canvas = document.getElementById('writeCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        
        // AI ç‹€æ…‹
        let worker = null;
        let isAIReady = false; 
        let isAIModeOn = true; // ä½¿ç”¨è€…æ˜¯å¦æƒ³ç”¨ AI

        function init() {
            // 1. é¦¬ä¸Šé¡¯ç¤ºéŠæˆ²ç•«é¢ï¼Œä¸ç­‰å¾…
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            setupCanvas();
            startLevel();

            // 2. åœ¨èƒŒæ™¯å˜—è©¦è¼‰å…¥ AI
            initAI();
        }

        async function initAI() {
            try {
                // å¦‚æœ Tesseract æ²’è¼‰å…¥ï¼Œç›´æ¥æ”¾æ£„
                if (typeof Tesseract === 'undefined') throw new Error("Tesseract not found");

                updateAIStatus("ä¸‹è¼‰ä¸­...", false);

                worker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status.includes('loading')) {
                            const p = m.progress ? Math.floor(m.progress * 100) : 0;
                            if(p % 20 === 0) updateAIStatus(`ä¸‹è¼‰ä¸­ ${p}%`, false);
                        }
                    }
                });
                
                // è¨­å®šç™½åå–® (åªè¾¨è­˜æ•¸å­—)
                await worker.setParameters({ tessedit_char_whitelist: '0123456789' });
                
                isAIReady = true;
                updateAIStatus("AI å·²å°±ç·’", true);
                refreshButtons(); // é‡æ–°æ•´ç†æŒ‰éˆ•é¡¯ç¤º

            } catch (err) {
                console.error("AI Init Failed", err);
                isAIReady = false;
                updateAIStatus("AI å¤±æ•— (é»æ“Šåˆ‡æ›æ‰‹å‹•)", false);
                document.getElementById('ai-switch').style.borderColor = "#ffcdd2";
            }
        }

        function updateAIStatus(text, ready) {
            document.getElementById('ai-label').innerText = text;
            const toggle = document.getElementById('ai-switch');
            if (ready) toggle.classList.add('active');
            else toggle.classList.remove('active');
        }

        function toggleAI() {
            // å…è¨±ä½¿ç”¨è€…æ‰‹å‹•é–‹é—œ AI æ¨¡å¼
            isAIModeOn = !isAIModeOn;
            
            // å¦‚æœè¦é–‹å•Ÿï¼Œä½† AI é‚„æ²’å¥½
            if (isAIModeOn && !isAIReady) {
                updateAIStatus("AI å•Ÿå‹•ä¸­...", false);
                // å¦‚æœä¹‹å‰å¤±æ•—äº†ï¼Œå†è©¦ä¸€æ¬¡
                if (!worker) initAI();
            } else if (!isAIModeOn) {
                updateAIStatus("æ‰‹å‹•æ¨¡å¼", false);
            } else {
                updateAIStatus("AI å·²å°±ç·’", true);
            }
            refreshButtons();
        }

        function refreshButtons() {
            // æ ¹æ“šã€ŒAI æ˜¯å¦æº–å‚™å¥½ã€ä»¥åŠã€Œä½¿ç”¨è€…æ˜¯å¦é–‹å•Ÿã€ä¾†æ±ºå®šé¡¯ç¤ºå“ªé¡†æŒ‰éˆ•
            const btnCheck = document.getElementById('btn-check'); // AI æŒ‰éˆ•
            const btnShow = document.getElementById('btn-show');   // æ‰‹å‹•æŒ‰éˆ•

            // åœ¨ã€Œå›ç­”éšæ®µã€ï¼ˆé‚„æ²’çœ‹ç­”æ¡ˆæ™‚ï¼‰
            if (document.getElementById('btn-yes').style.display === 'none') {
                if (isAIReady && isAIModeOn) {
                    btnCheck.style.display = 'block';
                    btnShow.style.display = 'none';
                    document.getElementById('status-msg').innerText = "ğŸ’¡ AI æº–å‚™å¹«ä½ æ”¹è€ƒå·";
                } else {
                    btnCheck.style.display = 'none';
                    btnShow.style.display = 'block';
                    document.getElementById('status-msg').innerText = "ğŸ’¡ è«‹è‡ªå·±å°ç­”æ¡ˆå–”";
                }
            }
        }

        // --- AI è¾¨è­˜é‚è¼¯ ---
        async function recognizeHandwriting() {
            if (!worker || !isAIReady) return;

            const btn = document.getElementById('btn-check');
            const txt = document.getElementById('btn-text');
            const spin = document.getElementById('loading-spin');
            const status = document.getElementById('status-msg');

            // é–å®šæŒ‰éˆ•
            btn.disabled = true;
            btn.style.opacity = "0.7";
            txt.innerText = "è¾¨è­˜ä¸­...";
            spin.style.display = "inline-block";
            if(typeof playClick === 'function') playClick();

            try {
                // è½‰æˆç™½åº•åœ–ç‰‡ (é‡è¦!)
                const dataURL = getCanvasWithWhiteBackground();
                
                // åŸ·è¡Œè¾¨è­˜
                const { data: { text } } = await worker.recognize(dataURL);
                const recognizedNum = text.trim();
                
                if (!recognizedNum) {
                    status.innerText = "â“ æ²’çœ‹åˆ°æ•¸å­—";
                    status.style.color = "#ef5350";
                } else if (parseInt(recognizedNum) === currentAnswer) {
                    status.innerText = `âœ… ç­”å°äº†ï¼æ˜¯ ${recognizedNum}`;
                    status.style.color = "#2e7d32";
                    if(typeof playSuccess === 'function') playSuccess();
                    score++;
                    setTimeout(nextQuestion, 1500);
                    return; 
                } else {
                    status.innerText = `âŒ é€™æ˜¯ ${recognizedNum} å—ï¼Ÿä¸å°å–”`;
                    status.style.color = "#c62828";
                }
            } catch (err) {
                status.innerText = "âš ï¸ è¾¨è­˜å¤±æ•—";
            } finally {
                btn.disabled = false;
                btn.style.opacity = "1";
                txt.innerText = "AI äº¤å·";
                spin.style.display = "none";
            }
        }

        // --- æ‰‹å‹•æ¨¡å¼ ---
        function showAnswer() {
            document.getElementById('correct-text').innerText = currentAnswer;
            document.getElementById('answer-reveal').style.display = 'block';
            
            // éš±è—äº¤å·æŒ‰éˆ•
            document.getElementById('btn-check').style.display = 'none';
            document.getElementById('btn-show').style.display = 'none';
            document.getElementById('btn-clear').style.display = 'none';
            
            // é¡¯ç¤ºå°éŒ¯æŒ‰éˆ•
            document.getElementById('btn-yes').style.display = 'block';
            document.getElementById('btn-no').style.display = 'block';
            
            if(typeof playClick === 'function') playClick();
        }

        function judge(isCorrect) {
            if(isCorrect) {
                score++;
                if(typeof playSuccess === 'function') playSuccess();
            } else {
                if(typeof playClick === 'function') playClick();
            }
            nextQuestion();
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function startLevel() {
            score = 0; round = 0;
            document.getElementById('level-title').innerText = LEVELS_CONFIG[currentLevel]?.title || "Level " + currentLevel;
            nextQuestion();
        }

        function nextQuestion() {
            if (round >= 5) {
                if (score >= 4) {
                    if (currentLevel < 3) {
                        alert(`ğŸ‰ æ™‰ç´šä¸‹ä¸€é—œï¼`); currentLevel++; startLevel();
                    } else {
                        alert("ğŸ† æ­å–œé€šé—œï¼"); location.href = 'index.html';
                    }
                } else {
                    alert("å†ç·´ç¿’ä¸€æ¬¡ï¼"); startLevel();
                }
                return;
            }
            round++;
            
            // é‡ç½® UI
            clearCanvas();
            document.getElementById('answer-reveal').style.display = 'none';
            document.getElementById('status-msg').innerText = "";
            document.getElementById('btn-yes').style.display = 'none';
            document.getElementById('btn-no').style.display = 'none';
            document.getElementById('btn-clear').style.display = 'block';

            // ç”¢ç”Ÿé¡Œç›®
            const qData = generateQuestion(currentLevel);
            document.getElementById('question-box').innerText = qData.q;
            currentAnswer = qData.a;
            
            // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºæŒ‰éˆ•
            refreshButtons();
        }

        function generateQuestion(level) {
            let config = LEVELS_CONFIG[level] || { min: 10, max: 20, type: 'ADD_CARRY' };
            const { min, max, type } = config;
            
            if (type === 'ADD_CARRY') {
                let a = r(min, max); let b = r(5, 9); while((a%10)+b<10) b++;
                return { q: `${a} + ${b} = ?`, a: a+b };
            } else if (type === 'SUB_BORROW') {
                let a = r(min, max); let b = r(5, 9); while((a%10)>=b) a=r(min, max);
                return { q: `${a} - ${b} = ?`, a: a-b };
            } else {
                let a = r(10, 20); let b = r(5, 10); let c = r(2, 8);
                return (Math.random()>0.5) ? { q: `${a} + ${b} - ${c} = ?`, a: a+b-c } : { q: `${a} - ${b} + ${c} = ?`, a: a-b+c };
            }
        }
        function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        // --- ç•«å¸ƒ ---
        function getCanvasWithWhiteBackground() {
            const w = canvas.width; const h = canvas.height;
            const t = document.createElement('canvas');
            t.width = w; t.height = h;
            const c = t.getContext('2d');
            c.fillStyle = '#ffffff'; c.fillRect(0, 0, w, h);
            c.drawImage(canvas, 0, 0);
            return t.toDataURL('image/png');
        }

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            ctx.lineWidth = 12; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#000';
        }
        function setupCanvas() {
            resizeCanvas();
            const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const {x,y} = pos(e); ctx.moveTo(x,y); };
            const move = (e) => { if(!isDrawing) return; e.preventDefault(); const {x,y} = pos(e); ctx.lineTo(x,y); ctx.stroke(); };
            const end = () => isDrawing = false;
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end); canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        }
        function pos(e) {
            const r = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - r.left, y: cy - r.top };
        }
        function clearCanvas() { 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            document.getElementById('status-msg').innerText = "";
            if(typeof playClick === 'function') playClick();
        }

        init();
    </script>
</body>
</html>
