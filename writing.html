<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·´å­—å°æ•™å®¤</title>
    <script src="data.js"></script>
    <script src="sound.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f1f8e9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; touch-action: none; }
        .top-bar { width: 100%; padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .back-btn { padding: 8px 15px; background: #bdbdbd; color: white; border: none; border-radius: 8px; font-weight: bold; text-decoration: none; font-size: 1.2rem; }
        h2 { margin: 0; color: #558b2f; font-size: 1.8rem; }
        #canvas-container { position: relative; width: 300px; height: 300px; margin: 20px auto; border: 6px dashed #aed581; border-radius: 25px; background-color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        canvas { position: absolute; top: 0; left: 0; border-radius: 20px; touch-action: none; }
        #bg-layer { z-index: 1; }
        #draw-layer { z-index: 2; cursor: crosshair; }
        .controls { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; width: 90%; max-width: 400px; }
        .btn { padding: 12px 0; font-size: 1.3rem; border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; flex: 1; min-width: 60px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-nav { background-color: #7e57c2; flex: 0.8; }
        .btn-clear { background-color: #ef5350; }
        .btn-check { background-color: #26a69a; flex: 1.5; font-size: 1.4rem; } 
        .btn-case { background-color: #ffa726; }
        .hidden { display: none !important; }
        #result-display { margin-top: 10px; font-size: 2.2rem; font-weight: bold; color: #333; height: 50px; text-align: center; }
        
        /* éŸ³æ¨‚æŒ‰éˆ• (ç¸®å°ç‰ˆ) */
        #mini-music { position: absolute; top: 15px; right: 15px; font-size: 1.2rem; cursor: pointer; background:none; border:none;}
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="index.html" class="back-btn" onclick="playClick()">ğŸ </a>
        <h2 id="current-letter">ç·´ç¿’: A</h2>
        <button id="mini-music" onclick="toggleMusic()">ğŸµ</button>
    </div>

    <div id="canvas-container">
        <canvas id="bg-layer" width="300" height="300"></canvas>
        <canvas id="draw-layer" width="300" height="300"></canvas>
    </div>

    <div id="result-display"></div>

    <div class="controls">
        <button class="btn btn-nav" onclick="changeLetter(-1)">â—€</button>
        <button class="btn btn-case" id="case-btn" onclick="toggleCase()">Aa</button>
        <button class="btn btn-nav" onclick="changeLetter(1)">â–¶</button>
    </div>
    <div class="controls" style="margin-top:15px;">
        <button class="btn btn-clear" onclick="clearCanvas()">é‡å¯«</button>
        <button class="btn btn-check" onclick="calculateScore()">ğŸ’¯ è©•åˆ†</button>
    </div>

    <script>
        // 1. å–å¾—ç¶²å€åƒæ•¸ (åˆ¤æ–·æ˜¯ EN é‚„æ˜¯ ZH)
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('type') || 'EN'; // é è¨­è‹±æ–‡

        let letters = [];
        if (mode === 'ZH') {
            letters = GAME_DATA.WRITING.ZH;
            document.getElementById('case-btn').classList.add('hidden'); // æ³¨éŸ³æ²’æœ‰å¤§å°å¯«
        } else {
            letters = GAME_DATA.WRITING.EN;
        }

        let currentIndex = 0;
        let isUpper = true;
        let isDrawing = false;
        
        const canvasSize = 300;
        const bgCanvas = document.getElementById('bg-layer');
        const bgCtx = bgCanvas.getContext('2d');
        const drawCanvas = document.getElementById('draw-layer');
        const drawCtx = drawCanvas.getContext('2d');
        const resultDisplay = document.getElementById('result-display');

        function init() {
            if(typeof GAME_DATA === 'undefined') { alert("è«‹ç¢ºèª data.js å­˜åœ¨"); return; }
            
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';
            drawCtx.lineWidth = 15; // ğŸ–Œï¸ ä¿®æ”¹è™•ï¼šç­†è§¸è®Šç´° (åŸ30 -> 15)
            drawCtx.strokeStyle = '#333'; 
            
            renderTemplate();
            setupEvents();
        }

        function renderTemplate() {
            bgCtx.clearRect(0, 0, canvasSize, canvasSize);
            let char = letters[currentIndex];
            if (mode === 'EN' && !isUpper) char = char.toLowerCase();
            
            document.getElementById('current-letter').innerText = `ç·´ç¿’: ${char}`;
            
            // ç•«æ ¼ç·š
            bgCtx.strokeStyle = '#e1f5fe'; bgCtx.lineWidth = 2; bgCtx.beginPath();
            bgCtx.moveTo(0, canvasSize/2); bgCtx.lineTo(canvasSize, canvasSize/2);
            bgCtx.moveTo(canvasSize/2, 0); bgCtx.lineTo(canvasSize/2, canvasSize);
            bgCtx.stroke();
            
            // ç•«ç¯„æœ¬å­—
            bgCtx.font = "200px Arial"; 
            if(mode === 'ZH') bgCtx.font = "180px Microsoft JhengHei"; // æ³¨éŸ³å­—é«”å¾®èª¿

            bgCtx.textAlign = "center"; bgCtx.textBaseline = "middle";
            bgCtx.fillStyle = "#cfd8dc"; 
            bgCtx.fillText(char, canvasSize/2, canvasSize/2 + 15);
        }

        function setupEvents() {
            const start = (e) => { e.preventDefault(); isDrawing = true; drawCtx.beginPath(); const {x, y} = getPos(e); drawCtx.moveTo(x, y); playClick(); }; // é»ä¸‹å»ä¹Ÿæœ‰è²éŸ³
            const move = (e) => { if (!isDrawing) return; e.preventDefault(); const {x, y} = getPos(e); drawCtx.lineTo(x, y); drawCtx.stroke(); };
            const end = () => isDrawing = false;
            drawCanvas.addEventListener('mousedown', start); drawCanvas.addEventListener('mousemove', move);
            drawCanvas.addEventListener('mouseup', end); drawCanvas.addEventListener('mouseout', end);
            drawCanvas.addEventListener('touchstart', start, {passive: false}); drawCanvas.addEventListener('touchmove', move, {passive: false}); drawCanvas.addEventListener('touchend', end);
        }

        function getPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function calculateScore() {
            const bgData = bgCtx.getImageData(0, 0, canvasSize, canvasSize).data;
            const drawData = drawCtx.getImageData(0, 0, canvasSize, canvasSize).data;
            let targetPixels = 0, hitPixels = 0, outsidePixels = 0;
            for (let i = 0; i < bgData.length; i += 4) {
                const hasTemplate = bgData[i+3] > 0; const hasDrawing = drawData[i+3] > 0;
                if (hasTemplate) { targetPixels++; if (hasDrawing) hitPixels++; } 
                else { if (hasDrawing) outsidePixels++; }
            }
            if (targetPixels === 0) return;
            if (hitPixels === 0) { resultDisplay.innerText = "è«‹å…ˆå¯«å­—å–”ï¼"; resultDisplay.style.color = "#555"; return; }
            
            let rawCoverage = (hitPixels / targetPixels) * 100;
            
            // ğŸ–Œï¸ ä¿®æ”¹è™•ï¼šå› ç‚ºç­†è®Šç´°äº†ï¼Œè¦†è“‹ç‡æœƒä¸‹é™ï¼Œæ‰€ä»¥æé«˜çå‹µä¿‚æ•¸ (1.2 -> 1.4)
            let boostedScore = rawCoverage * 1.4; 
            
            let penalty = (outsidePixels / targetPixels) * 100 * 0.1;
            let finalScore = Math.round(boostedScore - penalty);
            if (finalScore > 100) finalScore = 100; if (finalScore < 0) finalScore = 0;
            
            let msg = "", color = "";
            if (finalScore === 100) { msg = "ğŸŒŸ 100åˆ†ï¼å®Œç¾ï¼"; color = "#2e7d32"; playSuccess(); } // æ»¿åˆ†æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            else if (finalScore >= 90) { msg = "ğŸ˜ " + finalScore + "åˆ†ï¼å¤ªæ£’äº†ï¼"; color = "#43a047"; playSuccess(); }
            else if (finalScore >= 80) { msg = "ğŸ˜Š " + finalScore + "åˆ†ï¼å¾ˆä¸éŒ¯ï¼"; color = "#f57f17"; playClick(); }
            else { msg = "ğŸ¤” " + finalScore + "åˆ†ï¼Œå†è©¦è©¦ï¼"; color = "#d84315"; playClick(); }
            
            resultDisplay.innerText = msg; resultDisplay.style.color = color;
        }

        function clearCanvas() { drawCtx.clearRect(0, 0, canvasSize, canvasSize); resultDisplay.innerText = ""; playClick(); }
        
        function changeLetter(dir) { 
            currentIndex += dir; 
            if (currentIndex < 0) currentIndex = letters.length - 1; 
            if (currentIndex >= letters.length) currentIndex = 0; 
            clearCanvas(); 
            renderTemplate(); 
            playClick();
        }
        
        function toggleCase() { isUpper = !isUpper; clearCanvas(); renderTemplate(); playClick(); }

        // éŸ³æ¨‚æ§åˆ¶
        function toggleMusic() {
            const isPlaying = toggleBGM();
            document.getElementById('mini-music').innerText = isPlaying ? "â¸ï¸" : "ğŸµ";
        }

        init();
    </script>
</body>
</html>
