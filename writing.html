<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·´å­—å°æ•™å®¤ - æ™ºæ…§è©•åˆ†ç‰ˆ</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f1f8e9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; touch-action: none; }
        
        .top-bar { width: 100%; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .back-btn { padding: 8px 15px; background: #bdbdbd; color: white; border: none; border-radius: 8px; font-weight: bold; text-decoration: none; font-size: 1rem; margin-left: 10px; }
        
        h2 { margin: 0; color: #558b2f; font-size: 1.5rem; }

        /* ç•«å¸ƒå®¹å™¨ï¼šä½¿ç”¨ Relative å®šä½è®“å…©å€‹ Canvas é‡ç–Š */
        #canvas-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px auto;
            border: 5px dashed #aed581;
            border-radius: 20px;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 15px;
            touch-action: none; /* ç¦æ­¢è§¸æ§æ²å‹• */
        }
        
        /* bg-layer é¡¯ç¤ºæ·ºè‰²ç¯„æœ¬ï¼Œdraw-layer è®“ç”¨æˆ¶å¯«å­— */
        #bg-layer { z-index: 1; }
        #draw-layer { z-index: 2; cursor: crosshair; }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 95%; max-width: 500px; }
        .btn { padding: 12px 15px; font-size: 1.1rem; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; flex: 1; min-width: 80px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-nav { background-color: #7e57c2; }
        .btn-clear { background-color: #ef5350; }
        .btn-check { background-color: #26a69a; font-size: 1.3rem; flex: 2; } /* è©•åˆ†æŒ‰éˆ•å¤§ä¸€é» */
        .btn-case { background-color: #ffa726; }

        #result-display {
            margin-top: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            height: 40px;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="index.html" class="back-btn">ğŸ </a>
        <h2 id="current-letter">ç·´ç¿’: A</h2>
        <div style="width: 50px;"></div> </div>

    <div id="canvas-container">
        <canvas id="bg-layer" width="300" height="300"></canvas>
        <canvas id="draw-layer" width="300" height="300"></canvas>
    </div>

    <div id="result-display"></div>

    <div class="controls">
        <button class="btn btn-nav" onclick="changeLetter(-1)">â—€</button>
        <button class="btn btn-case" onclick="toggleCase()">Aa</button>
        <button class="btn btn-nav" onclick="changeLetter(1)">â–¶</button>
    </div>
    <div class="controls" style="margin-top:10px;">
        <button class="btn btn-clear" onclick="clearCanvas()">é‡å¯«</button>
        <button class="btn btn-check" onclick="calculateScore()">ğŸ’¯ è©•åˆ†</button>
    </div>

    <script>
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        let currentIndex = 0;
        let isUpper = true;
        let isDrawing = false;
        
        const canvasSize = 300;
        const bgCanvas = document.getElementById('bg-layer');
        const bgCtx = bgCanvas.getContext('2d');
        const drawCanvas = document.getElementById('draw-layer');
        const drawCtx = drawCanvas.getContext('2d');
        const resultDisplay = document.getElementById('result-display');

        // --- åˆå§‹åŒ–è¨­å®š ---
        function init() {
            // è¨­å®šç•«ç­†æ¨£å¼
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';
            drawCtx.lineWidth = 25; // ç”¨æˆ¶ç­†è§¸è¦æ¯”ç¯„æœ¬ç²—ä¸€é»ï¼Œæ¯”è¼ƒå®¹æ˜“è¦†è“‹
            drawCtx.strokeStyle = '#333'; 

            renderTemplate();
            setupEvents();
        }

        // --- ç¹ªè£½ç¯„æœ¬ (èƒŒæ™¯å±¤) ---
        function renderTemplate() {
            bgCtx.clearRect(0, 0, canvasSize, canvasSize);
            
            let char = letters[currentIndex];
            if (!isUpper) char = char.toLowerCase();
            
            document.getElementById('current-letter').innerText = `ç·´ç¿’: ${char}`;

            // ç¹ªè£½è¼”åŠ©ç·š
            bgCtx.strokeStyle = '#e0f7fa';
            bgCtx.lineWidth = 2;
            bgCtx.beginPath();
            bgCtx.moveTo(0, canvasSize/2); bgCtx.lineTo(canvasSize, canvasSize/2);
            bgCtx.moveTo(canvasSize/2, 0); bgCtx.lineTo(canvasSize/2, canvasSize);
            bgCtx.stroke();

            // ç¹ªè£½æ–‡å­—ç¯„æœ¬
            bgCtx.font = "200px Arial";
            bgCtx.textAlign = "center";
            bgCtx.textBaseline = "middle";
            bgCtx.fillStyle = "#cfd8dc"; // æ·ºç°è‰²ç¯„æœ¬
            bgCtx.fillText(char, canvasSize/2, canvasSize/2 + 15);
        }

        // --- äº‹ä»¶ç›£è½ (è§¸æ§èˆ‡æ»‘é¼ ) ---
        function setupEvents() {
            const start = (e) => {
                e.preventDefault();
                isDrawing = true;
                drawCtx.beginPath();
                const {x, y} = getPos(e);
                drawCtx.moveTo(x, y);
            };
            const move = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const {x, y} = getPos(e);
                drawCtx.lineTo(x, y);
                drawCtx.stroke();
            };
            const end = () => isDrawing = false;

            drawCanvas.addEventListener('mousedown', start);
            drawCanvas.addEventListener('mousemove', move);
            drawCanvas.addEventListener('mouseup', end);
            drawCanvas.addEventListener('mouseout', end);
            
            drawCanvas.addEventListener('touchstart', start, {passive: false});
            drawCanvas.addEventListener('touchmove', move, {passive: false});
            drawCanvas.addEventListener('touchend', end);
        }

        function getPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        // --- æ ¸å¿ƒè©•åˆ†é‚è¼¯ (Pixel Comparison) ---
        function calculateScore() {
            // 1. å–å¾—å…©å±¤çš„åƒç´ æ•¸æ“š
            const bgData = bgCtx.getImageData(0, 0, canvasSize, canvasSize).data;
            const drawData = drawCtx.getImageData(0, 0, canvasSize, canvasSize).data;

            let targetPixels = 0; // ç¯„æœ¬æœ‰å¤šå°‘åƒç´ 
            let hitPixels = 0;    // ç”¨æˆ¶å¡—å°äº†å¤šå°‘
            let outsidePixels = 0; // ç”¨æˆ¶å¡—å‡ºå»å¤šå°‘

            for (let i = 0; i < bgData.length; i += 4) {
                // æª¢æŸ¥ Alpha é€šé“ (é€æ˜åº¦ > 0 è¡¨ç¤ºæœ‰å…§å®¹)
                const hasTemplate = bgData[i+3] > 0; 
                const hasDrawing = drawData[i+3] > 0;

                if (hasTemplate) {
                    targetPixels++;
                    if (hasDrawing) hitPixels++;
                } else {
                    // å¦‚æœé€™è£¡æ˜¯ç©ºç™½ï¼Œä½†ç”¨æˆ¶ç•«äº†ï¼Œå°±æ˜¯ç•«å‡ºå»äº†
                    // ç‚ºäº†å®¹éŒ¯ï¼Œåªåœ¨å®Œå…¨åé›¢æ™‚æ‰£åˆ†
                    if (hasDrawing) outsidePixels++;
                }
            }

            if (targetPixels === 0) return; // é¿å…é™¤ä»¥é›¶

            // è¨ˆç®—è¦†è“‹ç‡ (0-100%)
            const coverage = (hitPixels / targetPixels) * 100;
            
            // è¨ˆç®—æº¢å‡ºæ‡²ç½° (ç•«å‡ºå»å¤ªå¤šæœƒæ‰£åˆ†ï¼Œä¿‚æ•¸ 0.2 è¡¨ç¤ºè¼•å¾®æ‡²ç½°)
            const penalty = (outsidePixels / targetPixels) * 100 * 0.2;

            // æœ€çµ‚åˆ†æ•¸å…¬å¼
            let finalScore = Math.round(coverage - penalty);
            if (finalScore < 0) finalScore = 0;
            if (finalScore > 100) finalScore = 100;

            // é¡¯ç¤ºçµæœ
            let msg = "";
            if (finalScore === 100) msg = "ğŸŒŸ å®Œç¾ï¼ (100åˆ†)";
            else if (finalScore >= 90) msg = "ğŸ˜ å¤ªæ£’äº†ï¼ (" + finalScore + "åˆ†)";
            else if (finalScore >= 70) msg = "ğŸ˜Š å¾ˆä¸éŒ¯ (" + finalScore + "åˆ†)";
            else if (finalScore >= 50) msg = "ğŸ˜ åŠ æ²¹ (" + finalScore + "åˆ†)";
            else msg = "ğŸ¤” å†è©¦è©¦ (" + finalScore + "åˆ†)";
            
            // å¦‚æœå®Œå…¨æ²’ç•«
            if (hitPixels === 0) msg = "è«‹å…ˆå¯«å­—å–”ï¼";

            resultDisplay.innerText = msg;
            
            // æ ¹æ“šåˆ†æ•¸è®Šè‰²
            if(finalScore >= 80) resultDisplay.style.color = "#2e7d32";
            else if(finalScore >= 50) resultDisplay.style.color = "#f57f17";
            else resultDisplay.style.color = "#c62828";
        }

        // --- æŒ‰éˆ•åŠŸèƒ½ ---
        function clearCanvas() {
            drawCtx.clearRect(0, 0, canvasSize, canvasSize);
            resultDisplay.innerText = "";
        }

        function changeLetter(dir) {
            currentIndex += dir;
            if (currentIndex < 0) currentIndex = 25;
            if (currentIndex > 25) currentIndex = 0;
            clearCanvas();
            renderTemplate();
        }

        function toggleCase() {
            isUpper = !isUpper;
            clearCanvas();
            renderTemplate();
        }

        init();
    </script>
</body>
</html>