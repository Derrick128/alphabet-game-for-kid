<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·´å­—å°æ•™å®¤</title>
    <script src="data.js"></script>
    <script src="sound.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Arial Rounded MT Bold', 'Microsoft JhengHei', sans-serif; background-color: #f1f8e9; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        
        /* --- é ‚éƒ¨å°èˆª --- */
        .top-bar { width: 100%; padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 10; }
        .nav-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px 10px; border-radius: 10px; transition: background 0.2s; }
        .nav-btn:active { background: #eee; transform: scale(0.95); }
        h2 { margin: 0; color: #558b2f; font-size: 1.5rem; }

        /* --- ç•«é¢ 1: ç¸½è¡¨é¸å–® (Grid View) --- */
        #selection-view { width: 100%; height: calc(100vh - 70px); overflow-y: auto; padding: 20px; box-sizing: border-box; }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            padding-bottom: 40px;
        }

        .char-card {
            background: white;
            border-radius: 20px;
            aspect-ratio: 1; /* æ­£æ–¹å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #444;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .char-card:active { transform: translateY(3px); box-shadow: none; }
        
        /* è‹±æ–‡å¡ç‰‡æ¨£å¼ */
        .grid-en .char-card { border-color: #b3e5fc; color: #0277bd; font-family: 'Arial', sans-serif; }
        .grid-en .char-card:hover { background-color: #e1f5fe; }
        
        /* æ³¨éŸ³å¡ç‰‡æ¨£å¼ */
        .grid-zh .char-card { border-color: #f8bbd0; color: #c2185b; font-size: 2rem; }
        .grid-zh .char-card:hover { background-color: #fce4ec; }


        /* --- ç•«é¢ 2: ç·´ç¿’æ¨¡å¼ (Practice View) --- */
        #practice-view { display: flex; flex-direction: column; align-items: center; width: 100%; }

        #canvas-container { position: relative; width: 300px; height: 300px; margin: 10px auto; border: 6px dashed #aed581; border-radius: 25px; background-color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        canvas { position: absolute; top: 0; left: 0; border-radius: 20px; touch-action: none; }
        #bg-layer { z-index: 1; }
        #draw-layer { z-index: 2; cursor: crosshair; }

        #result-display { margin-top: 5px; font-size: 1.8rem; font-weight: bold; color: #333; height: 40px; text-align: center; }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 95%; max-width: 400px; }
        .btn { padding: 10px 0; font-size: 1.2rem; border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; flex: 1; min-width: 60px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-nav { background-color: #7e57c2; flex: 0.6; }
        .btn-clear { background-color: #ef5350; }
        .btn-check { background-color: #26a69a; flex: 1.5; font-size: 1.3rem; } 
        .btn-case { background-color: #ffa726; }
        
    </style>
</head>
<body>

    <div class="top-bar">
        <button id="btn-home" class="nav-btn" onclick="goHome()">ğŸ </button>
        <button id="btn-back" class="nav-btn hidden" onclick="goBackToGrid()">â†©ï¸ åˆ—è¡¨</button>
        
        <h2 id="page-title">ç·´å­—å°æ•™å®¤</h2>
        
        <button class="nav-btn" onclick="toggleMusicDisplay()">ğŸµ</button>
    </div>

    <div id="selection-view">
        <div id="grid-container" class="grid-container">
            </div>
    </div>

    <div id="practice-view" class="hidden">
        <div id="canvas-container">
            <canvas id="bg-layer" width="300" height="300"></canvas>
            <canvas id="draw-layer" width="300" height="300"></canvas>
        </div>

        <div id="result-display"></div>

        <div class="controls">
            <button class="btn btn-nav" onclick="changeLetter(-1)">â—€</button>
            <button class="btn btn-case" id="case-btn" onclick="toggleCase()">Aa</button>
            <button class="btn btn-nav" onclick="changeLetter(1)">â–¶</button>
        </div>
        <div class="controls" style="margin-top:10px;">
            <button class="btn btn-clear" onclick="clearCanvas()">é‡å¯«</button>
            <button class="btn btn-check" onclick="calculateScore()">ğŸ’¯ è©•åˆ†</button>
        </div>
    </div>

    <script>
        // 1. åˆå§‹åŒ–è¨­å®š
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('type') || 'EN'; // 'EN' or 'ZH'
        
        let letters = [];
        let currentIndex = 0;
        let isUpper = true; // åƒ…è‹±æ–‡æœ‰æ•ˆ
        
        // ç•«å¸ƒè®Šæ•¸
        const canvasSize = 300;
        const bgCanvas = document.getElementById('bg-layer');
        const bgCtx = bgCanvas.getContext('2d');
        const drawCanvas = document.getElementById('draw-layer');
        const drawCtx = drawCanvas.getContext('2d');
        const resultDisplay = document.getElementById('result-display');
        let isDrawing = false;

        function init() {
            if(typeof GAME_DATA === 'undefined') { alert("è«‹ç¢ºèª data.js å­˜åœ¨"); return; }
            
            // è¨­å®šæ¨™é¡Œèˆ‡è³‡æ–™
            if (mode === 'ZH') {
                letters = GAME_DATA.WRITING.ZH;
                document.getElementById('page-title').innerText = "æ³¨éŸ³ç¬¦è™Ÿè¡¨";
                document.getElementById('case-btn').classList.add('hidden');
                document.getElementById('grid-container').className = "grid-container grid-zh";
            } else {
                letters = GAME_DATA.WRITING.EN;
                document.getElementById('page-title').innerText = "English ABC";
                document.getElementById('grid-container').className = "grid-container grid-en";
            }

            renderGrid();
            setupCanvas();
        }

        // --- ç¸½è¡¨é‚è¼¯ ---

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = ''; // æ¸…ç©º

            letters.forEach((char, index) => {
                const btn = document.createElement('div');
                btn.className = 'char-card';
                btn.innerText = char;
                btn.onclick = () => startPractice(index);
                container.appendChild(btn);
            });
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // --- ç·´ç¿’æ¨¡å¼åˆ‡æ› ---

        function startPractice(index) {
            playClick();
            currentIndex = index;
            isUpper = true; // æ¯æ¬¡é€²å»é è¨­å¤§å¯«

            // åˆ‡æ›è¦–åœ–
            document.getElementById('selection-view').classList.add('hidden');
            document.getElementById('practice-view').classList.remove('hidden');
            
            // åˆ‡æ›å°èˆªæŒ‰éˆ•
            document.getElementById('btn-home').classList.add('hidden');
            document.getElementById('btn-back').classList.remove('hidden');

            // æ¨™é¡Œè®Šæ›´
            document.getElementById('page-title').innerText = "ç·´ç¿’ä¸­...";

            // é‡ç½®ç•«å¸ƒ
            clearCanvas();
            renderTemplate();
        }

        function goBackToGrid() {
            playClick();
            // åˆ‡æ›è¦–åœ–
            document.getElementById('practice-view').classList.add('hidden');
            document.getElementById('selection-view').classList.remove('hidden');

            // åˆ‡æ›å°èˆªæŒ‰éˆ•
            document.getElementById('btn-back').classList.add('hidden');
            document.getElementById('btn-home').classList.remove('hidden');

            // æ¢å¾©æ¨™é¡Œ
            document.getElementById('page-title').innerText = (mode === 'ZH') ? "æ³¨éŸ³ç¬¦è™Ÿè¡¨" : "English ABC";
        }

        // --- ç•«å¸ƒèˆ‡è©•åˆ†é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½) ---

        function setupCanvas() {
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';
            drawCtx.lineWidth = 13; // ç­†è§¸ç¸®å°
            drawCtx.strokeStyle = '#333'; 

            const start = (e) => { e.preventDefault(); isDrawing = true; drawCtx.beginPath(); const {x, y} = getPos(e); drawCtx.moveTo(x, y); playClick(); };
            const move = (e) => { if (!isDrawing) return; e.preventDefault(); const {x, y} = getPos(e); drawCtx.lineTo(x, y); drawCtx.stroke(); };
            const end = () => isDrawing = false;

            drawCanvas.addEventListener('mousedown', start); drawCanvas.addEventListener('mousemove', move);
            drawCanvas.addEventListener('mouseup', end); drawCanvas.addEventListener('mouseout', end);
            drawCanvas.addEventListener('touchstart', start, {passive: false}); drawCanvas.addEventListener('touchmove', move, {passive: false}); drawCanvas.addEventListener('touchend', end);
        }

        function renderTemplate() {
            bgCtx.clearRect(0, 0, canvasSize, canvasSize);
            
            let char = letters[currentIndex];
            if (mode === 'EN' && !isUpper) char = char.toLowerCase();
            
            // è‹±æ–‡é¡¯ç¤º "ç·´ç¿’: A"ï¼Œæ³¨éŸ³é¡¯ç¤º "ç·´ç¿’: ã„…"
            document.getElementById('page-title').innerText = `ç·´ç¿’: ${char}`;
            
            // ç•«æ ¼ç·š
            bgCtx.strokeStyle = '#e1f5fe'; bgCtx.lineWidth = 2; bgCtx.beginPath();
            bgCtx.moveTo(0, canvasSize/2); bgCtx.lineTo(canvasSize, canvasSize/2);
            bgCtx.moveTo(canvasSize/2, 0); bgCtx.lineTo(canvasSize/2, canvasSize);
            bgCtx.stroke();
            
            // ç•«å­—é«”
            bgCtx.font = "200px Arial"; 
            if(mode === 'ZH') bgCtx.font = "180px Microsoft JhengHei"; 
            bgCtx.textAlign = "center"; bgCtx.textBaseline = "middle";
            bgCtx.fillStyle = "#cfd8dc"; 
            bgCtx.fillText(char, canvasSize/2, canvasSize/2 + 15);
        }

        function getPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function calculateScore() {
            const bgData = bgCtx.getImageData(0, 0, canvasSize, canvasSize).data;
            const drawData = drawCtx.getImageData(0, 0, canvasSize, canvasSize).data;
            let targetPixels = 0, hitPixels = 0, outsidePixels = 0;
            
            for (let i = 0; i < bgData.length; i += 4) {
                const hasTemplate = bgData[i+3] > 0; 
                const hasDrawing = drawData[i+3] > 0;
                if (hasTemplate) { targetPixels++; if (hasDrawing) hitPixels++; } 
                else { if (hasDrawing) outsidePixels++; }
            }

            if (targetPixels === 0) return;
            if (hitPixels === 0) { resultDisplay.innerText = "è«‹å…ˆå¯«å­—å–”ï¼"; resultDisplay.style.color = "#555"; return; }
            
            let rawCoverage = (hitPixels / targetPixels) * 100;
            let boostedScore = rawCoverage * 1.25; // çå‹µä¿‚æ•¸
            let penalty = (outsidePixels / targetPixels) * 100 * 0.1;
            
            let finalScore = Math.round(boostedScore - penalty);
            if (finalScore > 100) finalScore = 100; if (finalScore < 0) finalScore = 0;
            
            let msg = "", color = "";
            if (finalScore === 100) { msg = "ğŸŒŸ 100åˆ†ï¼å®Œç¾ï¼"; color = "#2e7d32"; playSuccess(); }
            else if (finalScore >= 90) { msg = "ğŸ˜ " + finalScore + "åˆ†ï¼å¤ªæ£’äº†ï¼"; color = "#43a047"; playSuccess(); }
            else if (finalScore >= 80) { msg = "ğŸ˜Š " + finalScore + "åˆ†ï¼å¾ˆä¸éŒ¯ï¼"; color = "#f57f17"; playClick(); }
            else { msg = "ğŸ¤” " + finalScore + "åˆ†ï¼Œå†è©¦è©¦ï¼"; color = "#d84315"; playClick(); }
            
            resultDisplay.innerText = msg; resultDisplay.style.color = color;
        }

        function clearCanvas() { drawCtx.clearRect(0, 0, canvasSize, canvasSize); resultDisplay.innerText = ""; playClick(); }
        
        function changeLetter(dir) { 
            currentIndex += dir; 
            if (currentIndex < 0) currentIndex = letters.length - 1; 
            if (currentIndex >= letters.length) currentIndex = 0; 
            clearCanvas(); renderTemplate(); playClick();
        }
        
        function toggleCase() { isUpper = !isUpper; clearCanvas(); renderTemplate(); playClick(); }

        function toggleMusicDisplay() {
            toggleBGM();
        }

        init();
    </script>
</body>
</html>


